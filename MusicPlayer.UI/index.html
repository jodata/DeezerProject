<!DOCTYPE html>
<html>
<head>
    <title>Get The Sound</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="scripts/angular.min.js"></script>
    <script src="scripts/angular-route.min.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--bootstrap -->
    <script src="scripts/bootstrap.min.js"></script>
    <link href="styles/bootstrap.min.css" rel="stylesheet">
    <!--style css pour l'interface-->
    <link href="styles/interface.css" rel="stylesheet">
</head>

<body ng-app="MusicPlayerApp">

    <div ng-include="'includes/nav.html'"></div>
    <div ng-view></div>
    <div ng-include="'includes/footer.html'"></div>

    <!--Scripts-->
    <script src="http://cdn-files.deezer.com/js/min/dz.js"></script>
    <script>
        DZ.init({
            appId  : 'YOUR_APP_ID',
            channelUrl : 'http://YOUR_DOMAIN/channel.html',
            player: {
                container: 'dz-player',
                width : 800,
                height : 300
            }
        });
    </script>

    <script>
        var app = angular.module('MusicPlayerApp', ['ngRoute']);

        app.config(function($routeProvider){
            $routeProvider
                    .when('/', {templateUrl: 'home.html'})
                    .when('/catalogue', {templateUrl: 'catalogue.html'})
                    .otherwise({redirectTo : '/'});
        });

        app.controller('MusicPlayerController', MusicPlayerController);

        function MusicPlayerController($scope){

            //this.musicPlayer = new MusicPlayerLocalClient();
            this.musicPlayer = new MusicPlayerRestClient();
            this.currentTrack   = null;
            this.proposedTracks = this.musicPlayer.getProposedTracks();
            this.proposedTracksName = null;
            this.previousTracks = null;
            this.albums = this.musicPlayer.getAlbums();
            this.catalogueTracks = this.musicPlayer.getTracks();

            this.currentTrackName  = null;
            this.currentTrackArtist = null;

            this.getTrackInfo = function () {
                var that = this;
                DZ.api('/track/' + this.currentTrack, function (track) {
                    that.currentTrackName  = track.title;
                    that.currentTrackArtist = track.artist.name;
                    that.currentTrackThumbailURL = track.album.cover;

                    // Explanation: https://docs.angularjs.org/guide/scope
                    $scope.$apply();
                });
            };

            this.getAllTracksInfo = function () {
                var that = this;
                that.proposedTracksName = [];
                for (var i = 0; i < that.proposedTracks.length; i++) {
                    DZ.api('/track/' + this.proposedTracks[i], function (track) {
                        that.proposedTracksName.push(track.title);
                        $scope.$apply();
                    });
                }
            };

            this.playNextTrack = function() {
                var nextTrack = this.musicPlayer.getNextTrack();
                DZ.player.playTracks( [nextTrack] );
                this.updatePlaylist();
            };

            this.addAlbumsTracks = function() {
                    this.musicPlayer.putAlbumTracks($("#albumID").val());
            };

            this.updatePlaylist = function () {

                this.currentTrack   = this.musicPlayer.getCurrentTrack();
                this.proposedTracks = this.musicPlayer.getProposedTracks();
                this.previousTracks = this.musicPlayer.getPreviousTracks();

                this.getTrackInfo();
            };
            this.getAllTracksInfo();

            this.updateContent = function(contentName){
                $.ajax({
                    url:  "tabs/"+contentName+".html",
                    async: false,
                    success: function(content) {
                        $("#tab-content").html(content);
                    },
                    error: function(xhr) {
                        console.log("Erreur lors du chargement de contenu de l\'onglet :" + contentName);
                    }
                });
            };
        } // class
    </script>

    <script>
        function MusicPlayerLocalClient(){

            var currentTrack   = null;
            var proposedTracks = [60946206, 60946207, 60946208, 60946209];
            var previousTracks = [ ];
            var albums         = [ ];
            var tracks         = [ ]

            this.getCurrentTrack = function(){
                return currentTrack;
            };

            this.getProposedTracks = function (){
                return proposedTracks;
            };

            this.getPreviousTracks = function(){
                return previousTracks;
            };

            this.getNextTrack = function(){
                previousTracks.push(currentTrack);
                currentTrack = proposedTracks.shift();
                return currentTrack;
            };

            this.getAlbums = function(){
                return albums;
            }

            this.getTracks = function(){
                return tracks;
            }
        } // class
    </script>

    <script>
        function MusicPlayerRestClient(){

            var CURRENT_TRACK_URI   = 'http://localhost:3000/playlist/currentTrack';
            var PROPOSED_TRACKS_URI = 'http://localhost:3000/playlist/proposedTracks';
            var PREVIOUS_TRACKS_URI = 'http://localhost:3000/playlist/previousTracks';
            var NEXT_TRACK_URI      = 'http://localhost:3000/playlist/nextTrack';
            var GET_ALBUMS          = 'http://localhost:3000/albums';
            var GET_TRACKS          = 'http://localhost:3000/tracks';
            var PUT_ALBUMS_TRACKS   = 'http://localhost:3000/tracks/album/{_}';
            var PUT_PROPOSED_TRACK  = 'http://localhost:3000/playlist/{_}';

            this.getCurrentTrack = function(){
                var currentTrack = this.doRequest('GET', CURRENT_TRACK_URI, null);
                return currentTrack;
            };

            this.getProposedTracks = function (){
                var proposedTracks = this.doRequest('GET', PROPOSED_TRACKS_URI, null);
                return proposedTracks;
            };

            this.getPreviousTracks = function(){
                var previousTracks = this.doRequest('GET', PREVIOUS_TRACKS_URI, null);
                return previousTracks;
            };

            this.getNextTrack = function(){
                var nextTrack = this.doRequest('POST', NEXT_TRACK_URI, null);
                return nextTrack;
            };

            this.getAlbums = function(){
                var albums = this.doRequest('GET', GET_ALBUMS, null);
                return albums;
            };

            this.getTracks = function () {
                var tracks = this.doRequest('GET', GET_TRACKS, null);
                return tracks;
            }

            this.putAlbumTracks = function(albumID){
                var url = PUT_ALBUMS_TRACKS.replace('{_}',albumID);
                this.doRequest('PUT', url, null);
            }

            this.putProposedTrack = function(trackID) {
                var url = PUT_PROPOSED_TRACK.replace('{_}',trackID);
                this.doRequest('PUT', url, null);
            }

            this.doRequest = function(verb, url, data) {

                var response;

                $.ajax({
                    url:  url,
                    type: verb,
                    data: data,
                    async: false,
                    success: function(resp) {
                        response = resp;
                    },
                    error: function(xhr) {
                        console.log("Error when " + verb + url);
                    }
                });

                return response;

            }; // method

        } // class
    </script>

</body>
</html>