<!DOCTYPE html>
<html>
<head>
    <title>Get The Sound</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="styles/bootstrap.min.css" rel="stylesheet">
    <!--style css pour l'interface-->
    <link href="styles/interface.css" rel="stylesheet">
</head>

<body ng-app="MusicPlayerApp">

    <div id="dz-root" class="row"></div>


    <div ng-controller="MusicPlayerController as musicPlayer">
        <!--barre des onglets en haut-->
        <div ng-include="'includes/nav.html'"></div>
        <div ng-view></div>
        <!--footer-->
        <div ng-include="'includes/footer.html'"></div>
        <!--javascript -->
    </div>
    <script src="scripts/angular.min.js"></script>
    <script src="scripts/angular-route.min.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--bootstrap -->
    <script src="scripts/bootstrap.min.js"></script>
    <script src="scripts/animation.js"></script>
    <!-- MVC -->
    <script src="http://cdn-files.deezer.com/js/min/dz.js"></script>
    <!--Deezer player -->
    <script>
        DZ.init({
            appId  : 'YOUR_APP_ID',
            channelUrl : 'http://YOUR_DOMAIN/channel.html',
            player: {
                    onload: function() {}
            }
        });
    </script>

    <!--Gestion des onglets : Playlist, Catalogue -->
    <script>
        var app = angular.module('MusicPlayerApp', ['ngRoute']);

        app.config(function($routeProvider){
            $routeProvider
                    .when('/home', {templateUrl: 'home_v2.html'})
                    .when('/catalogue', {templateUrl: 'catalogue.html'});
        });

        app.controller('MusicPlayerController', MusicPlayerController);

        <!--Contrôle des ajouts des chansons, de la mise à jour de playlist-->

        function MusicPlayerController($scope, $location){

            //this.musicPlayer = new MusicPlayerLocalClient();
            //this.musicPlayer = new MusicPlayerRestClient();
            $scope.musicPlayer = new MusicPlayerRestClient();
            $scope.proposedTracks = $scope.musicPlayer.getProposedTracks();
            $scope.currentTrack   = $scope.proposedTracks[0];
            $scope.previousTracks = $scope.musicPlayer.getPreviousTracks();
            $scope.albums = $scope.musicPlayer.getAlbums();
            $scope.tracks = $scope.musicPlayer.getTracks();
            $scope.ismute = false;
            $scope.offset = null;

            $scope.currentTrackName  = null;
            $scope.currentTrackArtist = null;

            <!--activer/afficher la page correspondante selon la location de l'utilisateur-->
            $scope.isActive = function(route) {
                return route === $location.path();
            };

            <!--récupérer les infos d'une chanson depuis Deezer -->
            $scope.getTrackInfo = function () {
                DZ.api('/track/' + $scope.currentTrack, function (track) {
                    $scope.currentTrackName  = track.title;
                    $scope.currentTrackArtist = track.artist.name;
                    $scope.currentTrackThumbailURL = track.album.cover;

                    // Explanation: https://docs.angularjs.org/guide/scope
                    $scope.$apply();
                });
            };
            $scope.getTrackInfo();

            // A Modifier Ne fonctionne pas
            $scope.getTrackName = function (id) {
                var res;
                DZ.api('/track/' + id, function (track) {
                     res = track.title;
                });
                return res;
            };

            <!--récupérer les infos des chansons choisies dans le catalogue -->
            $scope.getAllTracksInfo = function () {

                for (var i = 0; i < $scope.proposedTracks.length; i++) {
                    DZ.api('/track/' + $scope.proposedTracks[i], function (track) {
                        //$scope.proposedTracksName.push(track.title);
                    });
                }
            };

            $scope.filterTracks = function (albumID){
                var res = [];
                var id = 0;
                for(var i=0;i<$scope.albums.length;i++){
                    if($scope.albums[i].deezerID == albumID) {
                        id = i;
                        break;
                    }
                }
                angular.forEach($scope.tracks, function(track, j){
                    if(track.albumID == id)
                        res.push(track);
                });
                return res;
            };


            <!--ajouter les chansons d'un album dans musicPlayer-->
            $scope.addAlbumsTracks = function() {
                $scope.musicPlayer.putAlbumTracks($("#albumID").val());
            };
            <!--mettre à jour la playlist -->
            $scope.updatePlaylist = function () {

                $scope.currentTrack   = $scope.musicPlayer.getCurrentTrack();
                $scope.proposedTracks = $scope.musicPlayer.getProposedTracks();
                $scope.previousTracks = $scope.musicPlayer.getPreviousTracks();
                $scope.$apply();
            };

            <!-- ??? -->
            $scope.getAllTracksInfo();
            <!-- ??? -->

            $scope.notInPlaylist = function(deezerID){
                var id=0;
                for(id;id<$scope.tracks.length;id++){
                    if($scope.tracks[id].deezerID==deezerID)
                        break;
                }
                for(var i=0;i<$scope.proposedTracks.length;i++){
                    if($scope.proposedTracksName[i].trackID==id){
                        return true;
                        console.log(true);
                    }
                }
                console.log(false);
                return false;
            }

            $scope.addToPlaylist = function(deezerID){
                var id=0;
                for(id;id<$scope.tracks.length;id++){
                    if($scope.tracks[id].deezerID==deezerID)
                        break;
                }
                $scope.musicPlayer.putProposedTrack(id);
            }
            ///////////////////////////////////
            // FONCTION DE PLAYER DEEZER //////
            ///////////////////////////////////

            // Joue les tracks de la playlist du serveur
            $scope.playTracks = function() {
                $scope.proposedTracks = $scope.musicPlayer.getProposedTracks();
                console.log($scope.proposedTracks);
                DZ.player.playTracks( [$scope.proposedTracks], 0, 280 );
                $scope.$apply();
            };

            // Joue la current track du server
            $scope.playCurrentTrack = function() {
                var track = $scope.musicPlayer.getCurrentTrack();
                DZ.player.playTracks( [track] );
                // On peut ajouter un un index et un offset pour commencer à une certaine chanson et à un certain moment
                // DZ.player.playTracks( [track], index, offset);
            };

            $scope.playNextTrack = function() {
                var track = $scope.musicPlayer.getNextTrack();
                DZ.player.playTracks( [track] );
                // On peut ajouter un un index et un offset pour commencer à une certaine chanson et à un certain moment
                // DZ.player.playTracks( [track], index, offset);
            };


            $scope.mute = function() {
                if($scope.ismute)
                {
                    DZ.player.setVolume(100);
                    $scope.ismute = false;
                }

                else{
                    DZ.player.setVolume(0);
                    $scope.ismute = true;
                }
            };

            $scope.next = function() {
                DZ.player.next();
            };

            $scope.changePosition = function(pos) {
                DZ.player.seek(pos);
            };

            ///////////////////////////////////
            // EVENEMENTS DU PLAYER DEEZER //////
            ///////////////////////////////////

            //Indique la position du player
            DZ.Event.subscribe('player_position', function(e){
                console.log("Player position",  e);
            });

            //Indique des information sur une track qui démarre
            DZ.Event.subscribe('current_track', function(track){
                console.log("infoTrack",  track);
            });


            DZ.Event.subscribe('track_end', function(end){
                if(end){
                    $scope.playNextTrack();
                }
            });

            DZ.Event.subscribe('player_loaded', function(){
                $scope.getTrackInfo();
//                DZ.player.playTracks( [$scope.currentTrack] );
            });


        } // class
    </script>
    
    <script>
        /***************************************
         * client qui interagit avec le serveur *
         ****************************************/
        function MusicPlayerRestClient(){

            var CURRENT_TRACK_URI   = 'http://localhost:3000/playlist/currentTrack';
            var PROPOSED_TRACKS_URI = 'http://localhost:3000/playlist/proposedTracks';
            var PREVIOUS_TRACKS_URI = 'http://localhost:3000/playlist/previousTracks';
            var NEXT_TRACK_URI      = 'http://localhost:3000/playlist/nextTrack';
            var GET_ALBUMS          = 'http://localhost:3000/albums';
            var GET_TRACKS          = 'http://localhost:3000/tracks';
            var PUT_ALBUMS_TRACKS   = 'http://localhost:3000/tracks/album/{_}';
            var PUT_PROPOSED_TRACK  = 'http://localhost:3000/playlist/{_}';

            <!--récupérer la chanson courante-->
            this.getCurrentTrack = function(){
                var currentTrack = this.doRequest('GET', CURRENT_TRACK_URI, null);
                return currentTrack;
            };

            <!--récupérer les chansons choisies dans le catalogue-->
            this.getProposedTracks = function (){
                var proposedTracks = this.doRequest('GET', PROPOSED_TRACKS_URI, null);
                console.log(proposedTracks);
                return proposedTracks;
            };

            <!--récupérer les chansons suivantes-->
            this.getPreviousTracks = function(){
                var previousTracks = this.doRequest('GET', PREVIOUS_TRACKS_URI, null);
                return previousTracks;
            };

            <!--récupérer la chanson suivante-->
            this.getNextTrack = function(){
                var nextTrack = this.doRequest('POST', NEXT_TRACK_URI, null);
                return nextTrack;
            };

            <!--récupérer les albums-->
            this.getAlbums = function(){
                var albums = this.doRequest('GET', GET_ALBUMS, null);
                return albums;
            };

            <!--récupérer les chansons-->
            this.getTracks = function () {
                var tracks = this.doRequest('GET', GET_TRACKS, null);
                return tracks;
            };

            <!--ajouter les chansons d'un album-->
            this.putAlbumTracks = function(albumID){
                var url = PUT_ALBUMS_TRACKS.replace('{_}',albumID);
                this.doRequest('PUT', url, null);
            };

            <!--ajouter une chanson dans la playlist-->
            this.putProposedTrack = function(trackID) {
                var url = PUT_PROPOSED_TRACK.replace('{_}',trackID);
                this.doRequest('PUT', url, null);
            };

            <!-- requêtes des utilisateurs : get, put, post(, delete)-->
            this.doRequest = function(verb, url, data) {

                var response;

                $.ajax({
                    url:  url,
                    type: verb,
                    data: data,
                    async: false,
                    success: function(resp) {
                        response = resp;
                    },
                    error: function(xhr) {
                        console.log("Error when " + verb + url);
                    }
                });

                return response;

            }; // method

        } // class
    </script>

</body>
</html>